# Activation System Documentation

## Overview

The EVN Invoice Downloader now includes an activation system that requires users to activate the application before they can download invoices. The activation uses JWT (JSON Web Tokens) tied to unique device IDs.

## How It Works

1. **Device ID**: Each device generates a unique ID based on hardware information (hostname and MAC addresses)
2. **Activation Key**: A JWT token is generated by the admin that is valid only for a specific device ID
3. **Validation**: The application validates the activation key on startup and before downloads

## For Users

### Activating the Application

1. **Launch the application** - If not activated, you'll see an activation dialog
2. **Copy your Device ID** - Click the "Copy Device ID" button in the activation dialog
3. **Send Device ID to admin** - Contact the administrator and send them your Device ID
4. **Receive activation key** - The admin will send you an activation key
5. **Paste and activate** - Paste the activation key into the dialog and click "Activate"

### Manual Activation Access

If you need to access the activation dialog later:
- Click the **"Activation"** button in the main window

### Activation Status

- Once activated, the key is saved in `activation.key` file
- The activation is valid for 1 year from the date of generation
- If the activation key expires or becomes invalid, you'll need to request a new one

## For Administrators

### Generating Activation Keys

1. **Build the keygen tool** (if not already built):
   ```bash
   go build -o keygen cmd/keygen/main.go
   ```

2. **Run the keygen tool**:
   ```bash
   ./keygen
   ```

3. **Enter the user's Device ID** when prompted

4. **Send the generated activation key** to the user

### Example Session

```
$ ./keygen
=== EVN Invoice Downloader - Activation Key Generator ===

Please enter the Device ID from the user:
> a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

Generating activation key for device: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

=== ACTIVATION KEY (send this to the user) ===
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
==============================================

The user should paste this key into the activation dialog.
```

### Security Notes

⚠️ **Important Security Information**:

1. **Keep the secret key secure**: The JWT secret is defined in `activation/activation.go`. For production use, consider:
   - Using environment variables to store the secret
   - Using a more complex secret key
   - Changing the default secret key

2. **Change the default secret**: Edit `activation/activation.go` and update the `jwtSecret` constant:
   ```go
   const jwtSecret = "your-new-secret-key-here"
   ```

3. **Rebuild after changing secret**: After changing the secret key, rebuild both the main application and the keygen tool:
   ```bash
   go build -o bulk-invoice-downloader .
   go build -o keygen cmd/keygen/main.go
   ```

### Activation Key Properties

- **Expiration**: 1 year from generation (configurable in `activation/activation.go`)
- **Device-specific**: Each key only works on the device it was generated for
- **Algorithm**: HS256 (HMAC with SHA-256)

### Files

- `activation.key` - Stores the user's activation key (created on user's machine)
- `activation/activation.go` - Core activation logic
- `cmd/keygen/main.go` - Admin tool for generating activation keys

## Building

### Main Application
```bash
go build -o bulk-invoice-downloader .
```

### Keygen Tool
```bash
go build -o keygen cmd/keygen/main.go
```

## Troubleshooting

### "Activation key is not valid for this device"
- The activation key was generated for a different device
- Request a new activation key with the current device's Device ID

### "Activation key has expired"
- The activation key is older than 1 year
- Request a new activation key from the administrator

### "No activation key found"
- The application has not been activated yet
- The `activation.key` file was deleted
- Use the Activation dialog to activate the application

### Device ID Changed
If hardware changes (new network card, hostname change), the Device ID will change and a new activation key will be needed.
